
```javascript
function procesarDatos() {
  const SS = SpreadsheetApp.getActiveSpreadsheet();
  const hojaBase = SS.getSheetByName("base");
  const LIBRO_ORIGEN_ID = "MI_ID"; // Reemplaza "MI_ID" con el ID real del libro origen
  const BATCH_SIZE = 1000; // Tamaño del lote para procesar y escribir datos
  const COLUMNA_FILTRO = "A"; // Cambia esto a la letra de la columna que quieres usar
  const INDICE_COLUMNA_FILTRO = 0; // Cambia esto al índice de la columna que quieres usar (0 para A, 1 para B, 2 para C, etc.)

  // Obtener la lista de valores
  const ultimaFila = hojaBase.getLastRow();
  const lista = hojaBase.getRange(`${COLUMNA_FILTRO}2:${COLUMNA_FILTRO}${ultimaFila}`).getValues().flat().filter(String);
  const listaSet = new Set(lista);

  // Abrir el libro origen
  const libroOrigen = SpreadsheetApp.openById(LIBRO_ORIGEN_ID);
  const hojaDatosOrigen = libroOrigen.getSheetByName("datos_origen");

  // Preparar la hoja de destino
  let hojaDatos01 = SS.getSheetByName("datos_01");
  if (!hojaDatos01) {
    hojaDatos01 = SS.insertSheet("datos_01");
  } else {
    hojaDatos01.clear();
  }

  // Obtener todos los datos de origen
  const datosOrigen = hojaDatosOrigen.getDataRange().getValues();
  const numColumnas = datosOrigen[0].length;

  let datosFiltrados = [];
  let esEncabezado = true;

  // Filtrar datos
  datosOrigen.forEach((fila, index) => {
    if (esEncabezado) {
      datosFiltrados.push(fila);
      esEncabezado = false;
    } else if (listaSet.has(fila[INDICE_COLUMNA_FILTRO]) && fila[INDICE_COLUMNA_FILTRO] !== "") {
      datosFiltrados.push(fila);
    }

    // Escribir datos filtrados en lotes
    if (datosFiltrados.length >= BATCH_SIZE || index === datosOrigen.length - 1) {
      if (datosFiltrados.length > 0) {
        hojaDatos01.getRange(hojaDatos01.getLastRow() + 1, 1, datosFiltrados.length, numColumnas).setValues(datosFiltrados);
      }
      datosFiltrados = [];
    }

    // Pausa para evitar timeouts en ejecuciones largas
    if (index % (BATCH_SIZE * 10) === 0) {
      Utilities.sleep(1000);
      SpreadsheetApp.flush();
    }
  });

  SpreadsheetApp.flush();
  Logger.log("Proceso completado");
}
```

Cambios principales:

1. **Obtención de datos**: En lugar de usar `getRange()` con `getLastRow()`, ahora usamos `getDataRange().getValues()` para obtener todos los datos de la hoja de origen. Esto ignora cualquier filtro aplicado y obtiene todos los datos.

2. **Procesamiento de datos**: Ahora procesamos los datos fila por fila usando `forEach()`, lo que nos permite manejar más fácilmente el encabezado y aplicar el filtro.

3. **Escritura por lotes**: Mantenemos la escritura por lotes para optimizar el rendimiento.

4. **Manejo de filtros**: Al obtener todos los datos de una vez, evitamos problemas con filtros existentes.

